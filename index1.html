<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Carta Navide√±a</title>

<style>
  :root{
    --bg1:#070a14; --bg2:#1a0f24;
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.65);
    --gold:#f2d38a; --rose:#ff6b9a;
    --radius:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);}
  body{
    background:
      radial-gradient(1000px 700px at 20% 15%, rgba(70,30,120,.55) 0%, transparent 60%),
      radial-gradient(900px 700px at 85% 20%, rgba(120,25,85,.42) 0%, transparent 60%),
      linear-gradient(160deg,var(--bg1),var(--bg2));
    overflow-x:hidden;
  }

  canvas{position:fixed; inset:0; pointer-events:none; z-index:0;}
  .fog{
    position:fixed; inset:-20%;
    background:
      radial-gradient(900px 420px at 20% 30%, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(800px 400px at 80% 70%, rgba(255,255,255,.05), transparent 62%),
      radial-gradient(700px 380px at 40% 85%, rgba(255,255,255,.04), transparent 65%);
    filter: blur(10px);
    opacity: .9;
    animation: fogDrift 18s ease-in-out infinite alternate;
    pointer-events:none;
    z-index:1;
  }
  @keyframes fogDrift{
    from{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
    to{ transform: translate3d(2%, 1%, 0) scale(1.04); }
  }
  .vignette{
    position:fixed; inset:0;
    background: radial-gradient(circle at 50% 45%, transparent 35%, rgba(0,0,0,.65) 100%);
    pointer-events:none;
    z-index:2;
  }

  .wrap{
    min-height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 14px;
    position:relative;
    z-index:3;
  }

  .phone{
    width:min(420px, 100%);
    border-radius: var(--radius);
    overflow:hidden;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    position:relative;
  }

  .ribbon{
    padding: 14px 16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background: linear-gradient(90deg, rgba(242,211,138,.18), rgba(255,107,154,.10));
    border-bottom: 1px solid rgba(255,255,255,.12);
  }
  .badge{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:rgba(255,255,255,.78);}
  .chip{
    display:flex; gap:8px; align-items:center;
    padding:8px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.08);
    font-size:12px; color:rgba(255,255,255,.85);
  }
  .dot{width:8px; height:8px; border-radius:50%; background:var(--rose); box-shadow:0 0 18px rgba(255,107,154,.55);}

  .screen{
    height: calc(100svh - 90px);
    padding: 16px;
    overflow: hidden;
  }
  .hidden{display:none !important;}

  /* Lock */
  .title{font-size:22px; margin:10px 0 6px; line-height:1.15;}
  .subtitle{font-size:14px; color:var(--muted); margin:0 0 14px;}
  .field{
    display:flex; align-items:center;
    padding:10px 12px;
    border-radius:16px;
    background: rgba(0,0,0,.22);
    border: 1px solid rgba(255,255,255,.16);
  }
  input{
    width:100%;
    background: transparent;
    border:none;
    outline:none;
    color: var(--text);
    font-size: 15px;
    padding: 6px 2px;
  }
  input::placeholder{ color: rgba(255,255,255,.45); }
  .btn{
    width:100%;
    margin-top: 12px;
    padding: 12px 14px;
    border:none;
    border-radius: 16px;
    color: #121212;
    font-weight:800;
    background: linear-gradient(90deg, var(--gold), #ffd7a6, #ff9ec1);
    cursor:pointer;
  }
  .error{margin-top:10px; font-size:13px; min-height:18px; color: rgba(255,180,180,.95);}

  /* Letter layout */
  .letterWrap{
    height: 100%;
    display:flex;
    flex-direction:column;
    gap: 12px;
    position:relative;
  }

  /* ===== ENVELOPE STAGE ===== */
  .envelopeWrap{
    height: 152px;
    display:grid;
    place-items:center;
    filter: drop-shadow(0 16px 26px rgba(0,0,0,.40));
    z-index: 6;
    position:relative;
  }

  .envStage{
    width: 248px;
    height: 148px;
    position:relative;
    transform: translateZ(0);
    transition: transform 720ms cubic-bezier(.2,.95,.15,1);
  }
  .envStage.absorbLift{
    transform: translateY(-10px) scale(1.01);
  }

  .slot{
    position:absolute;
    left: 16px; right: 16px;
    top: 58px;
    height: 10px;
    border-radius: 999px;
    background: rgba(0,0,0,.28);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: inset 0 6px 10px rgba(0,0,0,.35);
    z-index: 7;
    pointer-events:none;
  }
  .slot::after{
    content:"";
    position:absolute; inset:0;
    border-radius: 999px;
    background: linear-gradient(90deg, transparent, rgba(242,211,138,.18), transparent);
    opacity:.0;
    transform: translateX(-30%);
    transition: opacity 600ms ease, transform 900ms ease;
  }
  .envStage.absorbLift .slot::after{
    opacity:.65;
    transform: translateX(30%);
  }

  .env{
    position:absolute; inset:0;
    border-radius: 18px;
    background: linear-gradient(180deg, rgba(255,255,255,.13), rgba(255,255,255,.06));
    border: 1px solid rgba(255,255,255,.16);
    overflow:hidden;
    z-index: 5;
  }
  .env::before{
    content:"";
    position:absolute; left:0; right:0; bottom:-1px; height:78%;
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    clip-path: polygon(0 0, 50% 64%, 100% 0, 100% 100%, 0 100%);
    border-top: 1px solid rgba(255,255,255,.10);
  }

  .flap{
    position:absolute; left:0; right:0; top:-1px; height:72%;
    background: linear-gradient(180deg, rgba(242,211,138,.24), rgba(255,107,154,.09));
    clip-path: polygon(0 0, 50% 72%, 100% 0, 100% 100%, 0 100%);
    transform-origin: top center;
    transform: rotateX(175deg);
    transition: transform 1150ms cubic-bezier(.2,.9,.2,1);
    border-bottom: 1px solid rgba(255,255,255,.12);
  }
  .closing .flap{ transform: rotateX(0deg); }

  .seal{
    position:absolute; left:50%; top:62%;
    transform: translate(-50%,-50%) scale(.92);
    width: 46px; height: 46px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,107,154,.22) 55%, rgba(255,107,154,.10));
    border: 1px solid rgba(255,255,255,.18);
    display:grid; place-items:center;
    user-select:none;
    opacity: .86;
    transition: transform 520ms cubic-bezier(.2,1.05,.2,1), opacity 520ms ease, box-shadow 520ms ease;
  }
  .seal span{ font-size: 16px; text-shadow: 0 8px 20px rgba(255,107,154,.30); }

  .sealPop{
    transform: translate(-50%,-50%) scale(1.18);
    opacity: 1;
    box-shadow: 0 0 30px rgba(255,107,154,.22), 0 0 55px rgba(242,211,138,.10);
  }

  /* ===== LETTER ===== */
  .letterCard{
    flex: 1;
    min-height: 0;
    padding: 14px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.07);
    box-shadow: 0 14px 42px rgba(0,0,0,.33);
    position:relative;
    overflow: visible;
    transform: translateZ(0);
    transition: opacity 1200ms ease, filter 1200ms ease, transform 800ms ease;
    z-index: 4;
  }
  .letterCard.slideUp{
    transform: translateY(-18px) scale(0.99);
  }
  .letterCard.fadeOut{
    opacity: 0;
    filter: blur(7px) saturate(.95);
    transform: translateY(10px) scale(.985);
  }

  .letterHeader{
    display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    margin-bottom: 8px;
  }
  .letterHeader h2{margin:0; font-size:18px; line-height:1.15;}
  .date{font-size:12px; color:rgba(255,255,255,.62); white-space:nowrap; margin-top:2px;}

  .paperMask{
    position:relative;
    height: calc(100% - 34px);
    overflow:hidden;
    border-radius: 14px;
  }
  .paperMask::before{
    content:"";
    position:absolute;
    left:0; right:0;
    top:0;
    height: 26px;
    background: linear-gradient(180deg, rgba(0,0,0,.22), transparent);
    pointer-events:none;
    z-index: 3;
    opacity: .55;
  }

  .paper{
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    padding-right: 6px;
    transition: transform 900ms cubic-bezier(.2,.95,.15,1),
                opacity 900ms ease,
                filter 900ms ease;
    position:relative;
    z-index: 2;
  }
  .paper.insertIntoSlot{
    transform: translateY(-160px) scale(0.97);
    opacity: 0.14;
    filter: blur(1.6px);
  }

  .type{
    font-size: 15px;
    line-height: 1.65;
    white-space: pre-wrap;
    color: rgba(255,255,255,.90);
  }
  .cursor{
    display:inline-block;
    width: 10px;
    height: 1.1em;
    border-left: 2px solid rgba(255,255,255,.70);
    transform: translateY(2px);
    margin-left: 2px;
    animation: blink .95s steps(1) infinite;
  }
  @keyframes blink{ 50%{ opacity:0; } }
  .signature{
    margin-top: 12px;
    font-style: italic;
    color: rgba(255,255,255,.78);
    display:none;
  }

  .actions{display:flex; gap:10px; flex-wrap:wrap;}
  .softBtn{
    flex:1; min-width: 140px;
    padding: 10px 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.88);
    font-weight:700;
    cursor:pointer;
  }

  /* Final overlay */
  .finalOverlay{
    position:absolute;
    inset: 0;
    display:none;
    align-items:center;
    justify-content:center;
    padding: 16px;
    z-index: 20;
    background: radial-gradient(900px 500px at 50% 10%, rgba(242,211,138,.12), transparent 60%),
                rgba(0,0,0,.18);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .finalOverlay.show{ display:flex; }
  .finalCard{
    width: 100%;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.08);
    padding: 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,.45);
  }
  .finalCard h3{ margin: 0 0 6px; font-size: 18px; }
  .finalCard p{
    margin: 0 0 12px;
    color: rgba(255,255,255,.75);
    font-size: 14px;
    line-height: 1.5;
  }
  .finalCard .tiny{ font-size: 12.5px; color: rgba(255,255,255,.68); margin-top: 10px; }
  .finalCard .row{ display:flex; gap:10px; margin-top: 12px; flex-wrap:wrap; }
  .finalCard button{
    flex:1;
    border:none;
    border-radius: 16px;
    padding: 10px 12px;
    font-weight:800;
    cursor:pointer;
    background: rgba(255,255,255,.10);
    color: rgba(255,255,255,.92);
    border: 1px solid rgba(255,255,255,.14);
  }
  .finalCard button.primary{
    background: linear-gradient(90deg, var(--gold), #ffd7a6, #ff9ec1);
    color: #121212;
    border:none;
  }

  /* Floating */
  .float{
    position: fixed;
    right: 14px;
    bottom: 14px;
    z-index: 50;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .fab{
    width: 52px; height: 52px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.30);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: rgba(255,255,255,.9);
    display:grid; place-items:center;
    box-shadow: 0 16px 40px rgba(0,0,0,.40);
    cursor:pointer;
    user-select:none;
  }
  .fab small{font-size:11px; opacity:.85; display:block; margin-top:2px;}
</style>
</head>

<body>
  <canvas id="fx"></canvas>
  <div class="fog"></div>
  <div class="vignette"></div>

  <div class="wrap">
    <div class="phone">
      <div class="ribbon">
        <div class="badge">Carta Navide√±a</div>
        <div class="chip"><span class="dot"></span><span id="status">Bloqueada</span></div>
      </div>

      <!-- LOCK -->
      <div id="lockScreen" class="screen">
        <h1 class="title">Escribe la canci√≥n que marc√≥ tu vida‚Ä¶</h1>
        <p class="subtitle">La carta ya fue le√≠da‚Ä¶ hoy solo queda el final bonito. (Frase secreta para entrar.)</p>

        <div class="field">
          <input id="secretInput" type="password" autocomplete="off" placeholder="Frase secreta‚Ä¶" />
        </div>

        <button id="unlockBtn" class="btn">Entrar</button>
        <div id="error" class="error" aria-live="polite"></div>

        <p class="subtitle" style="margin-top:10px; font-size:13px;">
          Pista: una palabra suave‚Ä¶ como flores que recuerdan en silencio üå∫
        </p>
      </div>

      <!-- LETTER -->
      <div id="letterScreen" class="screen hidden">
        <div class="letterWrap">

          <div class="envelopeWrap">
            <div class="envStage" id="envStage">
              <div class="slot"></div>
              <div class="env" id="env">
                <div class="flap"></div>
                <div class="seal" id="seal"><span id="sealIcon">‚ú¶</span></div>
              </div>
            </div>
          </div>

          <div class="letterCard" id="letterCard">
            <div class="letterHeader">
              <h2>Ep√≠logo de Navidad‚Ä¶</h2>
              <div class="date" id="today"></div>
            </div>

            <div class="paperMask">
              <div class="paper" id="paper">
                <div class="type" id="typeTarget"></div><span class="cursor" id="cursor"></span>
                <div class="signature" id="signature">Atentamente, <b>bcaal</b></div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="softBtn" id="copyBtn">üì© Copiar</button>
            <button class="softBtn" id="replayBtn">üîÅ Releer</button>
          </div>

          <div class="finalOverlay" id="finalOverlay">
            <div class="finalCard">
              <h3>Y listo‚Ä¶ la carta volvi√≥ al coraz√≥n ‚ú®</h3>
              <p>
                Ojal√° que la pr√≥xima Navidad nos encuentre m√°s cerca,
                y que los abrazos sean <b>f√≠sicos</b>, no virtuales.
                Que el ‚Äúfeliz Navidad‚Äù sea una mirada,
                una risa‚Ä¶ y un abrazo que se quede.
              </p>
              <div class="row">
                <button class="primary" id="restartAllBtn">Volver a abrir el sobre</button>
                <button id="closeOverlayBtn">Cerrar</button>
              </div>
              <div class="tiny">Tip: si est√°s en navegador interno (WhatsApp/Facebook), usa ‚ÄúAbrir en Chrome/Safari‚Äù.</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="float">
    <div class="fab" id="musicBtn">üéµ<small id="musicLbl">OFF</small></div>
    <div class="fab" id="heartBtn">‚ù§<small>Click</small></div>
  </div>

  <audio id="song" preload="auto" loop>
    <source src="cancion.mp3" type="audio/mpeg" />
  </audio>

<script>
  const SECRET = "amapolas";

  const letterText =
`Y as√≠‚Ä¶ la carta lleg√≥ a su final.

Ya fue abierta.
Ya fue le√≠da.
Y cumpli√≥ su prop√≥sito:
llegar hasta ti‚Ä¶ aunque fuera desde lejos.

Hoy, en Navidad, no quiero hablar solo de lo que falta.
Quiero hablar de lo que queda.

S√≠‚Ä¶ duele que mis brazos no te alcancen.
Pero tambi√©n es bonito saber que, incluso en la distancia,
hay un hilo invisible que todav√≠a nos une.

Esta carta no naci√≥ para impresionar,
ni por su valor econ√≥mico.
Naci√≥ para decirte, con calma,
que te tengo presente.

Te pienso cuando suena una canci√≥n.
Te recuerdo en las luces,
en el fr√≠o de la noche,
en esos silencios que en diciembre pesan un poquito m√°s.

Y aun as√≠‚Ä¶ mira esto:
a pesar de todo, seguimos.
Seguimos aprendiendo,
seguimos respirando,
seguimos creyendo.

Hoy quiero dejarte algo distinto:
no tristeza‚Ä¶
sino gratitud.

Gracias por lo vivido.
Por lo bonito.
Por lo que me ense√±√≥.
Por lo real que se sinti√≥.

Y si esta Navidad los abrazos fueron virtuales‚Ä¶
yo le pido a la pr√≥xima una cosa sencilla:

que el abrazo sea real.
Que sea f√≠sico.
Que sea de esos que no se explican,
solo se sienten.

Feliz Navidad. ‚ú®
Te Amo Morenita üå∫`;

  // Elements
  const lockScreen = document.getElementById("lockScreen");
  const letterScreen = document.getElementById("letterScreen");
  const secretInput = document.getElementById("secretInput");
  const unlockBtn = document.getElementById("unlockBtn");
  const errorBox = document.getElementById("error");
  const status = document.getElementById("status");

  const typeTarget = document.getElementById("typeTarget");
  const cursor = document.getElementById("cursor");
  const signature = document.getElementById("signature");
  const paper = document.getElementById("paper");

  const copyBtn = document.getElementById("copyBtn");
  const replayBtn = document.getElementById("replayBtn");

  const envStage = document.getElementById("envStage");
  const env = document.getElementById("env");
  const seal = document.getElementById("seal");
  const sealIcon = document.getElementById("sealIcon");
  const letterCard = document.getElementById("letterCard");

  const finalOverlay = document.getElementById("finalOverlay");
  const restartAllBtn = document.getElementById("restartAllBtn");
  const closeOverlayBtn = document.getElementById("closeOverlayBtn");

  const song = document.getElementById("song");
  const musicBtn = document.getElementById("musicBtn");
  const musicLbl = document.getElementById("musicLbl");
  const heartBtn = document.getElementById("heartBtn");

  // Date
  const d = new Date();
  document.getElementById("today").textContent =
    d.toLocaleDateString("es-GT", { year:"numeric", month:"long", day:"numeric" });

  // Helpers
  const delay = (ms) => new Promise(r => setTimeout(r, ms));
  function isNearBottom(el, threshold = 90){
    return el.scrollTop + el.clientHeight >= el.scrollHeight - threshold;
  }

  // ===== WebAudio SFX (sin archivos extra) =====
  let audioCtx = null;
  function ensureAudioCtx(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended") audioCtx.resume();
  }

  function playWhoosh(duration=0.55){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const noiseBuf = audioCtx.createBuffer(1, audioCtx.sampleRate * duration, audioCtx.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++){
      data[i] = (Math.random()*2-1) * (1 - i/data.length);
    }
    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuf;

    const filter = audioCtx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.setValueAtTime(800, t0);
    filter.frequency.exponentialRampToValueAtTime(1200, t0 + duration*0.55);
    filter.Q.setValueAtTime(0.7, t0);

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.22, t0 + 0.06);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);

    noise.connect(filter).connect(gain).connect(audioCtx.destination);
    noise.start(t0);
    noise.stop(t0 + duration);
  }

  function playClick(){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;

    // peque√±o "click" con oscilador + envolvente muy corta
    const osc = audioCtx.createOscillator();
    osc.type = "triangle";
    osc.frequency.setValueAtTime(420, t0);

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.18, t0 + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.06);

    // un poco de filtro para suavizar
    const filter = audioCtx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.setValueAtTime(1200, t0);

    osc.connect(filter).connect(gain).connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + 0.07);
  }

  function playPop(){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    osc.type = "sine";
    osc.frequency.setValueAtTime(220, t0);
    osc.frequency.exponentialRampToValueAtTime(520, t0 + 0.08);

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.22, t0 + 0.015);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.16);

    const filter = audioCtx.createBiquadFilter();
    filter.type = "highpass";
    filter.frequency.setValueAtTime(180, t0);

    osc.connect(filter).connect(gain).connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + 0.18);
  }

  // ===== M√∫sica (cancion.mp3) =====
  async function fadeInMusic(){
    try{
      song.volume = 0;
      await song.play();
      musicLbl.textContent = "ON";
      let v = 0;
      const t = setInterval(()=>{
        v += 0.03;
        song.volume = Math.min(v, 0.7);
        if(v >= 0.7) clearInterval(t);
      }, 120);
    }catch{
      musicLbl.textContent = "OFF";
    }
  }

  function fadeOutMusic(){
    if(song.paused) return;
    let v = song.volume;
    const t = setInterval(()=>{
      v -= 0.03;
      song.volume = Math.max(v, 0);
      if(v <= 0){
        clearInterval(t);
        song.pause();
        musicLbl.textContent = "OFF";
      }
    }, 120);
  }

  let typing = false;
  let cancelTyping = false;

  function resetScene(){
    typeTarget.textContent = "";
    signature.style.display = "none";
    cursor.style.display = "inline-block";

    finalOverlay.classList.remove("show");

    envStage.classList.remove("absorbLift");
    env.classList.remove("closing");
    seal.classList.remove("sealPop");
    sealIcon.textContent = "‚ú¶";

    letterCard.classList.remove("fadeOut", "slideUp");
    paper.classList.remove("insertIntoSlot");
    paper.scrollTop = 0;
  }

  async function typeWrite(text){
    typing = true;
    cancelTyping = false;
    resetScene();

    for(let i=0;i<text.length;i++){
      if(cancelTyping) break;

      const ch = text[i];
      const stick = isNearBottom(paper);

      typeTarget.textContent += ch;
      if(stick) paper.scrollTop = paper.scrollHeight;

      let ms = 60;
      if(ch === ",") ms = 170;
      if(ch === ".") ms = 250;
      if(ch === "‚Ä¶") ms = 320;
      if(ch === "\n") ms = 240;
      ms += Math.floor(Math.random()*18);

      await delay(ms);
    }

    cursor.style.display = "none";
    typing = false;
    if(cancelTyping) return;

    await delay(450);
    signature.style.display = "block";
    paper.scrollTop = paper.scrollHeight;

    await delay(900);
    await closeSequenceUltra();
  }

  async function closeSequenceUltra(){
    // 1) carta se acerca al sobre
    letterCard.classList.add("slideUp");
    await delay(160);

    // 2) sobre sube levemente (absorbe) + whoosh suave
    envStage.classList.add("absorbLift");
    playWhoosh(0.55);
    await delay(140);

    // 3) papel entra por ranura (sube y desaparece) + whoosh cortito
    paper.classList.add("insertIntoSlot");
    playWhoosh(0.42);
    await delay(680);

    // 4) cierre solapa + click
    env.classList.add("closing");
    sealIcon.textContent = "‚ù§";
    playClick();
    await delay(260);

    // 5) pop del sello + pop
    seal.classList.add("sealPop");
    playPop();

    // 6) esfumado carta + fade out m√∫sica
    await delay(420);
    letterCard.classList.add("fadeOut");
    fadeOutMusic();

    // 7) final overlay
    await delay(900);
    finalOverlay.classList.add("show");

    // corazones suaves
    for(let i=0;i<12;i++){
      spawnHeart(innerWidth*0.5 + rand(-14,14), innerHeight*0.62 + rand(-12,12));
    }
  }

  function unlock(){
    const val = (secretInput.value || "").trim().toLowerCase();
    if(val !== SECRET){
      errorBox.textContent = "Esa no es la palabra‚Ä¶ intenta otra vez üå∫";
      return;
    }
    errorBox.textContent = "";
    status.textContent = "Abierta";

    lockScreen.classList.add("hidden");
    letterScreen.classList.remove("hidden");

    // Activar WebAudio por gesto del usuario
    ensureAudioCtx();

    fadeInMusic();
    typeWrite(letterText);
  }

  unlockBtn.addEventListener("click", unlock);
  secretInput.addEventListener("keydown", (e)=> { if(e.key === "Enter") unlock(); });

  // Music toggle
  musicBtn.addEventListener("click", async ()=> {
    ensureAudioCtx();
    if(song.paused){
      await fadeInMusic();
    }else{
      fadeOutMusic();
    }
  });

  // Copy
  copyBtn.addEventListener("click", async ()=> {
    const txt = typeTarget.textContent + "\n\nAtentamente, bcaal";
    try{
      await navigator.clipboard.writeText(txt);
      copyBtn.textContent = "‚úÖ Copiado";
      setTimeout(()=> copyBtn.textContent = "üì© Copiar", 1200);
    }catch{
      copyBtn.textContent = "‚ö†Ô∏è Error";
      setTimeout(()=> copyBtn.textContent = "üì© Copiar", 1200);
    }
  });

  // Releer
  replayBtn.addEventListener("click", ()=> {
    ensureAudioCtx();
    cancelTyping = true;
    setTimeout(()=>{
      cancelTyping = false;
      fadeInMusic();
      typeWrite(letterText);
    }, 80);
  });

  // Overlay controls
  closeOverlayBtn.addEventListener("click", ()=> finalOverlay.classList.remove("show"));

  restartAllBtn.addEventListener("click", ()=> {
    ensureAudioCtx();
    finalOverlay.classList.remove("show");
    cancelTyping = true;
    setTimeout(()=>{
      cancelTyping = false;
      fadeInMusic();
      typeWrite(letterText);
    }, 120);
  });

  // ===== FX: snow + hearts =====
  const canvas = document.getElementById("fx");
  const ctx = canvas.getContext("2d");
  function resize(){
    canvas.width = innerWidth * devicePixelRatio;
    canvas.height = innerHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  addEventListener("resize", resize);
  resize();

  const flakes = [];
  const hearts = [];
  const rand = (a,b)=>Math.random()*(b-a)+a;

  function spawnFlake(){
    flakes.push({ x: rand(0, innerWidth), y:-10, r: rand(1,3), s: rand(.6,1.5), vx: rand(-.35,.35), a: rand(.2,.7) });
  }
  function spawnHeart(x,y){
    hearts.push({ x, y, vx: rand(-.7,.7), vy: rand(-2.4,-1.4), life: 1, rot: rand(-.25,.25), size: rand(10,18) });
  }
  function drawHeart(x,y,size,alpha,rot){
    ctx.save();
    ctx.translate(x,y); ctx.rotate(rot); ctx.globalAlpha = alpha;
    ctx.beginPath();
    const s = size/16;
    ctx.moveTo(0, 6*s);
    ctx.bezierCurveTo(0, 0, -8*s, 0, -8*s, 6*s);
    ctx.bezierCurveTo(-8*s, 12*s, 0, 14*s, 0, 18*s);
    ctx.bezierCurveTo(0, 14*s, 8*s, 12*s, 8*s, 6*s);
    ctx.bezierCurveTo(8*s, 0, 0, 0, 0, 6*s);
    ctx.closePath();
    ctx.fillStyle = "rgba(255,107,154,0.9)";
    ctx.fill();
    ctx.restore();
  }

  let lastSnow=0;
  function tick(t){
    ctx.clearRect(0,0,innerWidth,innerHeight);

    if(t-lastSnow > (lockScreen.classList.contains("hidden") ? 70 : 130)){
      spawnFlake();
      if(Math.random()<.35) spawnFlake();
      lastSnow=t;
    }
    for(let i=flakes.length-1;i>=0;i--){
      const f=flakes[i];
      f.y += f.s*1.12;
      f.x += f.vx;
      ctx.globalAlpha = f.a;
      ctx.beginPath();
      ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
      ctx.fillStyle="white";
      ctx.fill();
      if(f.y > innerHeight+10) flakes.splice(i,1);
    }

    for(let i=hearts.length-1;i>=0;i--){
      const h=hearts[i];
      h.x += h.vx; h.y += h.vy; h.life -= 0.012;
      drawHeart(h.x,h.y,h.size,Math.max(h.life,0),h.rot);
      if(h.life<=0) hearts.splice(i,1);
    }

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  heartBtn.addEventListener("click", ()=> {
    ensureAudioCtx();
    playPop();
    for(let i=0;i<10;i++) spawnHeart(innerWidth-50+rand(-8,8), innerHeight-120+rand(-8,8));
  });
  document.addEventListener("click",(e)=>{
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if(["input","button"].includes(tag)) return;
    spawnHeart(e.clientX, e.clientY);
  });
</script>
</body>
</html>
